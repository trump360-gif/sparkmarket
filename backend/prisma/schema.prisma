generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password_hash String
  nickname      String        @unique
  avatar_url    String?

  // 역할 (일반 유저 / 관리자)
  role   String @default("USER") // USER | ADMIN

  // 계정 상태
  status String @default("ACTIVE") // ACTIVE | BANNED

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  products           Product[]
  favorites          Favorite[]
  sentPriceOffers    PriceOffer[] @relation("price_offers_buyer_idTousers")
  receivedPriceOffers PriceOffer[] @relation("price_offers_seller_idTousers")

  @@index([email])
  @@index([role, status])
  @@map("users")
}

model Product {
  id          String   @id @default(cuid())
  seller_id   String
  seller      User     @relation(fields: [seller_id], references: [id], onDelete: Cascade)

  title       String   @db.VarChar(100)
  description String   @db.Text
  price       Int
  category    String

  status      String   @default("FOR_SALE") // FOR_SALE | SOLD | DELETED

  view_count  Int      @default(0)
  chat_count  Int      @default(0)

  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  images       ProductImage[]
  favorites    Favorite[]
  priceOffers  PriceOffer[]

  @@index([seller_id, created_at(sort: Desc)])
  @@index([status, created_at(sort: Desc)])
  @@index([category, created_at(sort: Desc)])
  @@index([title])
  @@map("products")
}

model ProductImage {
  id         String   @id @default(cuid())
  product_id String
  url        String
  key        String
  width      Int?
  height     Int?
  size       Int?
  format     String?
  order      Int      @default(0)
  is_primary Boolean  @default(false)
  created_at DateTime @default(now())
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([product_id, order])
  @@map("product_images")
}

model CommissionSettings {
  id              String   @id @default(cuid())
  commission_rate Float    @default(5.0)
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@map("commission_settings")
}

model Transaction {
  id                String   @id @default(cuid())
  product_id        String
  seller_id         String
  buyer_id          String
  product_price     Int
  commission_rate   Float
  commission_amount Int
  seller_amount     Int
  status            String   @default("COMPLETED")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  @@index([seller_id, created_at(sort: Desc)])
  @@index([buyer_id, created_at(sort: Desc)])
  @@index([created_at(sort: Desc)])
  @@index([status, created_at(sort: Desc)])
  @@map("transactions")
}

model Favorite {
  id         String   @id @default(cuid())
  user_id    String
  product_id String
  created_at DateTime @default(now())
  product    Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, product_id])
  @@index([product_id])
  @@index([user_id, created_at(sort: Desc)])
  @@map("favorites")
}

model PriceOffer {
  id            String   @id @default(cuid())
  product_id    String
  buyer_id      String
  seller_id     String
  offered_price Int
  message       String?
  status        String   @default("PENDING") // PENDING | ACCEPTED | REJECTED | CANCELLED | EXPIRED
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  expires_at    DateTime
  buyer         User     @relation("price_offers_buyer_idTousers", fields: [buyer_id], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  seller        User     @relation("price_offers_seller_idTousers", fields: [seller_id], references: [id], onDelete: Cascade)

  @@index([buyer_id, created_at(sort: Desc)])
  @@index([product_id, created_at(sort: Desc)])
  @@index([seller_id, status, created_at(sort: Desc)])
  @@index([status, expires_at])
  @@map("price_offers")
}
